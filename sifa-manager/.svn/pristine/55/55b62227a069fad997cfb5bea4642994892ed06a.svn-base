<%@ page language="java" import="java.util.*" pageEncoding="UTF-8"%>
<%@ include file="/WEB-INF/views/include/taglib.jsp"%>
<link rel="stylesheet" type="text/css"
	href="${ctxStatic}/lib/upload/webuploader.css" />
<script type="text/javascript"
	src="${ctxStatic}/lib/upload/webuploader.js" charset="utf-8"></script>
<script type="text/javascript"
	src="${ctxStatic}/lib/upload/MyWebUpload.js" charset="utf-8"></script>
<script type="text/javascript" src="${ctxStatic }/extJs.js" charset="utf-8"></script>
<div class="easyui-layout" data-options="fit:true,border:false">
	<div data-options="region:'east',border:true,split:false,title:'查询条件'" style="width: 240px;">
        <div class="easyui-layout" data-options="fit:true,border:false">
        <div region="center" border="false">
         <c:if test="${!fns:isLeafGroup(fns:getSysAccount().groupId) }">
			<sys:sysGroup hiddenId="sfsGroupId" hiddenName="sfsGroupId" dataGridId="moveIn_list_content"/>
	        </c:if>
           <div class="easyui-panel search-form" data-options="fit:true,border:false" id="p2" title="<c:if test="${!fns:isLeafGroup(fns:getSysAccount().groupId) }">查询项目</c:if>" style="width:100%;">
           
		<form id="moveInSearchForm" style="padding-bottom: 10px;padding-top: 10px;">
			<table>
				<tr>
					<td class="search-title">矫正对象：</td>
					<td>
						<input name="name"  class="easyui-textbox"/>
					</td>
				</tr>
				<tr>
					<td class="search-title">身份证号码：</td>
					<td>
						<input name="cedentialsNumber"  class="easyui-textbox"/>
					</td>
				</tr>
				<tr>
					<td class="search-title">迁入起始：</td>
					<td>
						<input name="startDate" class="Wdate easyui-validatebox" onclick="WdatePicker({readOnly:true,dateFmt:'yyyy-MM-dd'})"
						editable="false"  />
					</td>
				</tr>
				<tr>
					<td class="search-title">迁入截止：</td>
					<td>
						<input name="endDate" class="Wdate easyui-validatebox" onclick="WdatePicker({readOnly:true,dateFmt:'yyyy-MM-dd'})"
						editable="false"  />
					</td>
				</tr>
				<!-- 	<td><a href="javascript:void(0);" class="easyui-linkbutton"
						id="searchbtn">搜索</a>
					<a href="javascript:void(0);"
						class="easyui-linkbutton" id="cleanSearch">清空</a></td> -->
			</table>
		</form>
	</div>
	</div>
		<div data-options="region:'south',border:false" style="height: 30px;line-height:30px; overflow: hidden;text-align: center;background-color: #eee" ><a
			href="#" class="easyui-linkbutton" iconCls="icon-search" onclick="javascript:$('#moveIn_list_content').datagrid('load' ,$.serializeObject($('#moveInSearchForm')));"
			id="searchGroupBtn">查询</a> &nbsp;&nbsp; <a href="#"
			class="easyui-linkbutton" id="cleanGroupBtn" iconCls="icon-undo" onclick="javascript:$('#moveInSearchForm').form('clear');">清空</a></div>
		</div>
	</div>
	<div region="center" border="false">
		<table class="easyui-datagrid" id="moveIn_list_content" style="height: 400px;" title="迁入列表" 
			data-options="singleSelect:true,collapsible:true,fit:true,striped:true,fitColumns:true,toolbar:moveInListToolbar,loadMsg: '数据正在加载,请耐心的等待...' ,pagination:true,pageSize: 15 ,pageList:[5,10,15,20,50],fitColumns:true,url:'${ctx}/culprit/moveIn/list',method:'post',onLoadSuccess:function (data) {
				  $('.organization-easyui-linkbutton-edit').linkbutton({text:'详情',plain:true,iconCls:'fi-info icon-blue'}); 
				  $('.organization-easyui-linkbutton-edit1').linkbutton({text:'处理',plain:true,iconCls:'fi-clipboard-pencil icon-blue'}); 
				  $('.organization-easyui-linkbutton-edit2').linkbutton({text:'流程图',plain:true,iconCls:'fi-shuffle  icon-blue'});
				  $('.organization-easyui-linkbutton-edit3').linkbutton({text:'终止',plain:true,iconCls:'fi-stop'});
		 }">
			<thead>
				<tr>
					<th data-options="field:'id',checkbox:true,width:'5%'">编号</th>
					<th data-options="field:'name',width:'13%',align:'center'"
						editor="{type:'validatebox',options:{required:true}}">矫正对象</th>
					<!-- <th data-options="field:'groupId',width:100,align:'center'"
						editor="text" editor="{type:'numberbox',options:{required:true}}">司法所</th>
					<th data-options="field:'oldGroup',width:100,align:'center'"
						editor="text" editor="{type:'numberbox',options:{required:true}}">原司法所</th>
					<th data-options="field:'place',width:250,align:'center'" editor="text">刑罚执行类别</th>
					<th data-options="field:'place',width:250,align:'center'" editor="text">犯罪类型</th>
					<th data-options="field:'place',width:250,align:'center'" editor="text">监管等级</th> -->
					<th data-options="field:'moveTime',width:'19%',align:'center',sortable:true"
						editor="{type:'validatebox',options:{required:true}}">迁入时间</th>
					<th data-options="field:'cedentialsNumber',width:'19%',align:'center'" editor="text">身份证号码</th>
					<!--<th data-options="field:'endDate',width:250,align:'center'"
						editor="text">录入时间</th>
					<th data-options="field:'redressPeriod',width:250,align:'center'"
						editor="text">矫正起止时间</th>-->
					<th data-options="field:'activityName',width:'19%',align:'center'"
						editor="text">流程状态</th>
					<th data-options="field:'action',width:'27%',align:'center'" formatter="formatterAct">操作</th>
				</tr>
			</thead>
		</table>
	</div>
<div  id="moveInListToolbar" style="display: none;">
	<c:if test="${account.roleId == '2007'}">
        <a onclick="addMoveIn();" href="javascript:void(0);" class="easyui-linkbutton" data-options="plain:true,iconCls:'fi-plus icon-green'" >新增</a>
         <a onclick="batchDeleteMoveIn();" href="javascript:void(0);" class="easyui-linkbutton" data-options="plain:true,iconCls:'fi-x icon-red'">删除</a>
	</c:if>
</div> 
	<div id="investigateDialog" title="调查人员" modal=true draggable=false iconCls="fi-clipboard-pencil icon-blue"
		class="easyui-dialog" closed=true style="width: 800px;">
		<form id="moveInForm" action="" method="post">
			<input type="hidden" id="investigateFormId" name="id" value="" />
			<table class="grid">
				<tr>
					<th><span class="c-red">*</span>姓名：</th>
					<td><input id="investigatorId1" name="investigatorId1" class="easyui-combobox" />
					<th>&nbsp;&nbsp;&nbsp;&nbsp;单位职务：</th>
					<td><input id="position1" name="position1" class="easyui-textbox" /></td>
				</tr> 
				<tr>
					<th>姓名：</th>
					<td><input id="investigatorId2" name="investigatorId2" class="easyui-combobox"/>
					<input type="hidden" id="investigator2" name="investigator2" value="" ></td>
					<th>&nbsp;&nbsp;&nbsp;&nbsp;单位职务：</td>
					<td><input id="position2" name="position2" class="easyui-textbox"/></td>
				</tr>
				<tr>
					<th>协理员：</th>
					<td><input id="assistorId1" class="easyui-combobox" name="assistorId1"/>
					<input type="hidden" id="assistor1" name="assistor1" value="" ></td>
					<th>&nbsp;&nbsp;&nbsp;&nbsp;单位职务：</th>
					<td><input id="position3" name="position3" class="easyui-textbox"/></td>
				</tr>
				<tr align="center">
					<td colspan="4"><a href="javascript:void(0);" onclick="investigateSubmit();" data-options="iconCls:'fi-check icon-blue'"  class="easyui-linkbutton">确定</a>
						<a href="javascript:void(0);" data-options="iconCls:'fi-x icon-blue'" onclick="$('#investigateDialog').dialog('close')" class="easyui-linkbutton">关闭</a></td>
				</tr>
			</table>
		</form>
	</div>
</div>
<script type="text/javascript">

	var flag; //undefined 判断新增和修改方法
	function addMoveIn(){
		 parent.$.modalDialog({
	         title : '新增迁入管理',
	         iconCls:'fi-plus icon-green',
	         //width : sy.getBrowerWidth()-250,
	         //height : sy.getBrowerHeight()*0.6,
	        width : sy.getBrowerWidth()-200,
		     height : sy.getBrowerHeight()-150,
	         href : '${ctx}/culprit/moveIn/moveInAddForm',
	         resizable : true,
	         maximizable:true, 
	         buttons : [ {
	             text : '保存',
	             iconCls:'icon-save',
	             handler : function() {
	                 parent.$.modalDialog.openner_dataGrid = $('#moveIn_list_content').datagrid();//因为添加成功之后，需要刷新这个dataGrid，所以先预定义好
	                 var f = parent.$.modalDialog.handler.find('#moveInAddInfo');
	                 f.submit();
	             }
	         }, {
	             text : '重置',
	             iconCls:'icon-undo',
	             handler : function() {
	            	 var f = parent.$.modalDialog.handler.find('#moveInAddInfo');
	            	 f.get(0).reset(); //清空表单数据 
	             }
	         },{
	        	 	text : '关闭',
	            	iconCls:'fi-x icon-blue',
	          		 handler : function() {
	          			parent.$.modalDialog.openner_dataGrid = $('#moveInAddInfo').datagrid();//因为添加成功之后，需要刷新这个dataGrid，所以先预定义好
						parent.$.modalDialog.handler.dialog('close');
	          		
	          		 }
			}  ]
	     });
	}
	
	
	function batchDeleteMoveIn(){
		var arr = $('#moveIn_list_content').datagrid('getSelections');
		if (arr.length <= 0) {
			$.messager.show({
				title : '提示信息!',
				msg : '至少选择一行记录进行删除!'
			});
		} 
		else {
			$.messager.confirm('提示信息', '确认删除?', function(r) {
				if (r) {
					var ids = '';
					for (var i = 0; i < arr.length; i++) {
						if (i == 0) {
							ids += arr[i].id
						} else {
							ids += "," + arr[i].id;
						}
					}
					//ids = ids.substring(0, ids.length - 1);
					$.post('${ctx}/culprit/moveIn/batchDelete', {
						ids : ids
					}, function(result) {
						//1 刷新数据表格 
						$('#moveIn_list_content').datagrid('reload');
						//2 清空idField   
						$('#moveIn_list_content').datagrid('uncheckAll');
						//3 给提示信息 
						$.messager.show({
							title : '提示信息!',
							msg : '操作成功!'
						});
					});
				} else {
					return;
				}
			});
		}
	}
	
	/**
	 *  提交表单方法
	 */
	
	$(function() {

		$('#t_list_content').datagrid({
			fit : true
		});
		/**
		 * 关闭窗口方法
		 */
		$('#btn2').click(function() {
			$('#mydialog').dialog('close');
		});

		$('#searchbtn').click(
				function() {
					$('#t_list_content').datagrid('load',
							serializeForm($('#searchForm')));
				});

		function cleanSearch() {
			$('#t_list_content').datagrid('load', {});
			$('#searchForm').form().find('input').val('');
		}

		//js方法：序列化表单 			
		function serializeForm(form) {
			var obj = {};
			$.each(form.serializeArray(),
					function(index) {
						if (obj[this['name']]) {
							obj[this['name']] = obj[this['name']] + ','
									+ this['value'];
						} else {
							obj[this['name']] = this['value'];
						}
					});
			return obj;
		}
		$('#cleanSearch').click(function () {
			$('#t_list_content').datagrid('load', {});
			$('#searchForm').form().find('input').val('');
		});
	});

	function formatRole(value, row, index) {
		var str = '';
		$.ajax({
			type : 'get',
			url : '${ctx}/sys/sysRole/findById?id=' + value,
			cache : false,
			async : false, //同步请求
			dataType : 'json',
			success : function(result) {
				str = result.name;
			}
		});
		return str;

	}
	


//格式化函数
function formatterAct(value,row,index){
	var str = '';
	
	if(row.processInstanceId!='' && row.processInstanceId!=null){
		str += $.formatString('<a class="organization-easyui-linkbutton-edit" data-options="plain:true,iconCls:\'fi-info\'" onclick="submitAuditMoveIn(\'{0}\',\'{1}\',\'{2}\',\'{3}\',\'{4}\',\'{5}\');" style="cursor: hand;cursor:pointer;" ><span style="color:blue;"><strong><u>详细</u></strong></span></a>&nbsp;&nbsp;&nbsp;&nbsp;',row.id,row.taskId,row.auditType,row.processInstanceId,1,row.isEnd);
		var processDetailUrl="/culprit/moveIn/forProcessDetail?id="+row.id;
		if(row.isEnd==1){//若流程结束，则查看整个流程图片
			var url = '${ctx}/flow/forQueryProcessDefinitionResource?processDefinitionId='+row.processDefinitionId+'&resourceType=png';
			str += $.formatString('<a class="organization-easyui-linkbutton-edit2" data-options="plain:true,iconCls:\'formatterAct\'" onclick="showPic(\''+url+'&processDetailUrl='+processDetailUrl+'\');" style="cursor:hand;cursor:pointer;color:" ><span style="color:blue;"><strong><u>查看流程图</u></strong></span></a>&nbsp;&nbsp;&nbsp;&nbsp;',url);
		}else{//流程未结束，查看当前流程图
			var url = '${ctx}/flow/queryActivityMap?processInstanceId='+row.processInstanceId;
			str += $.formatString('<a class="organization-easyui-linkbutton-edit2" data-options="plain:true,iconCls:\'formatterAct\'" onclick="showPic(\''+url+'&processDetailUrl='+processDetailUrl+'\');" style="cursor:hand;cursor:pointer;color:" ><span style="color:blue;"><strong><u>查看流程图</u></strong></span></a>&nbsp;&nbsp;&nbsp;&nbsp;',url);
		}
		
		if(row.hasPermission==1){
			if(row.auditType=='sfsAccept'){
				str +=$.formatString('<a onclick="investigate(\'{0}\',\'{1}\');" class="organization-easyui-linkbutton-edit1" data-options="plain:true,iconCls:\'fi-clipboard-pencil\'" style="cursor:hand;cursor:pointer;" ><span style="color:blue;"><strong><u>开始调查</u></strong></span></a>&nbsp;&nbsp;&nbsp;&nbsp;',row.id,row.groupId);
			}else{                
				
					str += $.formatString('<a class="organization-easyui-linkbutton-edit1" data-options="plain:true,iconCls:\'fi-clipboard-pencil\'" onclick="submitAuditMoveIn(\'{0}\',\'{1}\',\'{2}\',\'{3}\',\'{4}\',\'{5}\');" style="cursor:hand;cursor:pointer;" ><span style="color:blue;"><strong><u>处理</u></strong></span></a>&nbsp;&nbsp;&nbsp;&nbsp;',row.id,row.taskId,row.auditType,row.processInstanceId,0,row.isEnd);
				
			}
		}
		
		
	}else{
		
	}
	return str;
	}
//格式化函数字符串拼接
$.formatString = function(str) {
	for ( var i = 0; i < arguments.length - 1; i++) {
	str = str.replace("{" + i + "}", arguments[i + 1]);
	}
	return str;
	};
//查看流程图
function showPic(url){
	 parent.$.modalDialog({
         title : '迁入流程',
         iconCls:'fi-plus icon-green',
         maximizable:true,
         width : sy.getBrowerWidth()-250,
         height : sy.getBrowerHeight()-150,
         href : url
     });
}
function deal(id,taskId,auditType,processId){
	$.ajax({
		type : 'post',
	 	url :"${ctx}/culprit/moveIn/submitMoveInAudit?id=" + id+"&taskId="+taskId+"&auditType="+auditType+"&processInstanceId="+processId,
		cache : false,
		async : false, //同步请求
		dataType : 'json',
		 buttons : [ {
             text : '审批',
             iconCls:'icon-save',
             handler : function() {
                 parent.$.modalDialog.openner_dataGrid = $('#moveIn_list_content').datagrid();//因为添加成功之后，需要刷新这个dataGrid，所以先预定义好
                 var f = parent.$.modalDialog.handler.find('#moveInUpdateInfo');
                 f.submit();
             }
         }]
	}); 
}
function submitAuditMoveIn(id,taskId,auditType,processId,d,end){
	var stopButton={};
	var checkButton={};
	var print={};
	var arr;
	var print1={};
	var print2={};
	var title1;
	var iconCls1;
	if(d==1){
		if(end==1){
			title1='详情'
			iconCls1='fi-info icon-blue'
			print={text : '打印《社区服刑人员居住地变更审批表》',
	            	iconCls:'icon-save',
	          		 handler : function() {
	          			 
	          			
		 	                $('#moveInPrint').click()

	          		 }
			};
			print1={text : '打印《社区服刑人员居住地变更证明》',
	            	iconCls:'icon-save',
	          		 handler : function() {
	          			 
	          			 
		 	                $('#moveInPrint1').click()
	          		 }
			};
			print2={text : '关闭',
	            	iconCls:'fi-x icon-blue',
	          		 handler : function() {
	          			 
	          			  var f = parent.$.modalDialog.handler.find('#moveInPrint2');
		 	                 f.click();
	          		 }
			};
			arr=[print,print1,print2]
		}else{
			title1='详情'
				iconCls1='fi-info icon-blue'
					print2={text : '关闭',
		            	iconCls:'fi-x icon-blue',
		          		 handler : function() {
		          			 
		          			  var f = parent.$.modalDialog.handler.find('#moveInPrint2');
			 	                 f.click();
		          		 }
				};
				arr=[print2]
		}

	}else{
		title1='审核'
		iconCls1='fi-clipboard-pencil icon-blue'
		if(auditType=='sgzryPrint'){
			stopButton={text : '结束流程',
		            	iconCls:'fi-info',
		           		 handler : function() {
		                parent.$.modalDialog.openner_dataGrid = $('#moveIn_list_content').datagrid();//因为添加成功之后，需要刷新这个dataGrid，所以先预定义好
		                var f = parent.$.modalDialog.handler.find('#moveInCheckForm');
		                f.submit();
		              // $('#checkMoveIn').window('center');
		            //$('#checkMoveIn').dialog('open');
		            }
		        }
			print={text : '打印《社区服刑人员居住地变更审批表》',
	            	iconCls:'icon-save',
	          		 handler : function() {
	          			 
	          			$('#moveInPrint').click()
	          		 }
			};
			print1={text : '打印《社区服刑人员居住地变更证明》',
	            	iconCls:'icon-save',
	          		 handler : function() {
	          			 
	          			$('#moveInPrint1').click()
	          		 }
			};
			print2={text : '关闭',
	            	iconCls:'fi-x icon-blue',
	          		 handler : function() {
	          			 
	          			  var f = parent.$.modalDialog.handler.find('#moveInPrint2');
		 	                 f.click();
		 	                
	          		 }
			};
			arr=[stopButton,print,print1,print2]
		}else{
			title1='审核'
			iconCls1='fi-clipboard-pencil icon-blue'
		checkButton={text : '审核',
	            iconCls:'icon-save',
	            handler : function() {
	                parent.$.modalDialog.openner_dataGrid = $('#moveIn_list_content').datagrid();//因为成功之后，需要刷新这个dataGrid，所以先预定义好
	              //  var f = parent.$.modalDialog.handler.find('#moveInAddInfo');
	               // f.submit();
	               
	            	$('#checkMoveIn').dialog('open');
	            }
	        }
		print2={text : '关闭',
            	iconCls:'fi-x icon-blue',
          		 handler : function() {
          			 
          			  var f = parent.$.modalDialog.handler.find('#moveInPrint2');
	 	                 f.click();
          		 }
		};
		arr=[checkButton,print2]
	
	}
	}
	
	parent.$.modalDialog({
        title : title1,
        iconCls:iconCls1,
        maximizable:true,
        width : sy.getBrowerWidth()-230,
        height : sy.getBrowerHeight()-150,
        href : '${ctx}/culprit/moveIn/checkMoveIn?id=' + id+'&taskId='+taskId+'&auditType='+auditType+'&processInstanceId='+processId,
        buttons :arr
    });
}
//工作人员上报
function reportMoveIn(id,taskId,auditType,processId){
	//location.href="${ctx}/culprit/moveIn/moveInAudit?id=" + id+"&taskId="+taskId+"&auditType="+auditType+"&processInstanceId="+processId;
	//open_layer('迁入审核审批','${ctx}/culprit/moveIn/moveInAudit?id=' + id+'&taskId='+taskId+'&auditType='+auditType+'&processInstanceId='+processId);
	parent.$.modalDialog({
        title : '上报',
        iconCls:'fi-clipboard-pencil icon-blue',
        width : sy.getBrowerWidth()-250,
        height : sy.getBrowerHeight()-150,
        href : '${ctx}/culprit/moveIn/reportMoveIn?id=' + id+'&taskId='+taskId+'&auditType='+auditType+'&processInstanceId='+processId,
        buttons : [ {
            text : '上报',
            iconCls:'icon-undo',
            handler : function() {
            	parent.$.modalDialog.openner_dataGrid = $('#moveIn_list_content').datagrid();//因为添加成功之后，需要刷新这个dataGrid，所以先预定义好	
           	 var reoprtMoveIn = parent.$.modalDialog.handler.find('#moveInReportForm');
           		reoprtMoveIn.submit(); //提交表单 
            }
        },{text : '关闭',
        	iconCls:'fi-x icon-blue',
     		 handler : function() {
     			parent.$.modalDialog.openner_dataGrid = $('#moveIn_list_content')
				.datagrid();//因为添加成功之后，需要刷新这个dataGrid，所以先预定义好
				parent.$.modalDialog.handler.dialog('close');
     		 }
	} ]
    });
}
//开始调查后处理流程用
function apply(id,taskId,auditType,processId){
	if($('#moveInForm').form('validate')){
		
		$.ajax({
			type : 'post',
		 	url :"${ctx}/culprit/moveIn/submitMoveInAudit?decideType=1&id=" + id+"&taskId="+taskId+"&auditType="+auditType+"&processInstanceId="+processId,
			cache : false,
			async : false, //同步请求
			dataType : 'json',
			success : function(result) {
				if(result.status==200){
					$.messager.show({
						title : '提示信息!',
						msg : '提交成功!'
					});
					parent.$.modalDialog.openner_dataGrid = $('#moveIn_list_content').datagrid();//因为添加成功之后，需要刷新这个dataGrid，所以先预定义好
					$('#investigateDialog').dialog('close');
					
				}
				
			}
		})
	}else{
		$.messager.show({
			title : '提示信息!',
			msg : '数据验证不通过,不能提交 !'
		});
	}

}
//开始调查指定人员的表单
$('#moveInForm').form({
	url:'${ctx}/culprit/moveIn/save',
	onSubmit:function(o){
		 progressLoad();
		 var isValid = $(this).form('validate');
         if (!isValid) {
             progressClose();
         }
         return isValid;
	},
	success:function(data){
		progressClose();
		data = JSON.parse(data);
		if(data.status==200){
			$('#investigateDialog').dialog('close')
			$('#moveIn_list_content').datagrid('reload');
		}else{
			 parent.$.messager.alert('错误', result.msg, 'error');
		}
		
	}
});
//打开开始调查表单初始化
function investigate(id,groupId){
	$('#moveInForm').form('clear');
	$('#investigatorId1').combobox({    
	    url:'${ctx}/sys/sysAccount/findSysAccount?groupId='+groupId,   
	    valueField:'id',    
	    textField:'accountname',
	    required:true,
	    panelHeight:'auto',
	    onChange:function(newValue,oldValue){  
	    	$.post("${ctx}/sys/sysAccount/roleName",{"id":newValue},
			function(data){
	    		$('#position1').textbox('setValue',data);
			});
	     }  
	}); 
	$('#investigatorId2').combobox({    
	    url:'${ctx}/sys/sysAccount/findSysAccount?groupId='+groupId,  
	    valueField:'id',    
	    textField:'accountname',
	    panelHeight:'auto'
	}); 
	
	$('#moveInForm').form('load',{
		id :id
	});
	$('#investigateDialog').dialog('open');
}
//开始调查确定后提交表单更新流程从司法所受理到工作人员
function investigateSubmit(){

	var arr = $('#moveIn_list_content').datagrid('getSelections');
	var id=arr[0].id;
	var taskId=arr[0].taskId;
	var auditType=arr[0].auditType;
	var processId=arr[0].processInstanceId;
	
	apply(id,taskId,auditType,processId);
	
     
}
//

</script>

</html>