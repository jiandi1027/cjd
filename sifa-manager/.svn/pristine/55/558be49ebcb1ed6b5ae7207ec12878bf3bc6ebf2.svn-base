<%@ page language="java" import="java.util.*" pageEncoding="UTF-8"%>
<%@ include file="/WEB-INF/views/include/taglib.jsp"%>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
	<table class="easyui-datagrid" id="first_report_list_content" 
			style="height:400px" data-options="singleSelect:true,fit:true,collapsible:false,striped:true,fitColumns:true,rownumbers:true">
			<thead>
				<tr>
					<th data-options="field:'studyDate',width:'50%',align:'center'">首次报到事项</th>
				 	<th data-options="field:'_opt',width:'29%',align:'center'">操作</th>
				 	<th data-options="field:'_opt1',width:'21%',align:'center'">完成标识</th>  
				</tr>
			</thead>
			<tbody>   
		        <tr>  
 					<td>社区矫正人员脸谱指纹信息采集</td>
	           		<td><a href="javascript:void(0);" class="easyui-linkbutton" data-options="iconCls:'fi-torsos-all icon-blue',plain:true" onclick="iface('${culprit.id}')"><strong>IFACE登记</strong></a></td>
		        	<td><span style="color:red;" name="finish" id="finshInfo1"><c:if test="${culprit.finshInfo1==1 }">已完成</c:if></span></td>
		        </tr>   
		        <tr>   
		            <td>社区矫正人员首次谈话笔录</td>
		            <td><a href="javascript:void(0);" class="easyui-linkbutton" data-options="iconCls:'fi-pencil icon-blue',plain:true" onclick="firstTalk('${culprit.id}')"><strong>录入</strong></a></td>   
		        	<td><span style="color:red;" name="finish" id="finshInfo2"><c:if test="${culprit.finshInfo2==1 }">已完成</c:if></span></td>
		        </tr>
		         <tr> 
		            <td>社区矫正人员资料</td>
		            <td><a href="javascript:void(0);" class="easyui-linkbutton" data-options="iconCls:'fi-pencil icon-blue',plain:true" onclick="updateInformation('${culprit.id}')"><strong>录入</strong></a></td>   
		        	<td><span style="color:red;" name="finish" id="finshInfo3"><c:if test="${culprit.finshInfo3==1 }">已完成</c:if></span></td>
		        </tr> 
		        <tr>  
		            <td>建立矫正小组</td>
		            <td><a href="javascript:void(0);" class="easyui-linkbutton" data-options="iconCls:'fi-torso icon-blue',plain:true" onclick="monitor('${culprit.id}')"><strong>录入</strong></a></td>   
		        	<td><span style="color:red;" name="finish" id="finshInfo4"><c:if test="${culprit.finshInfo4==1 }">已完成</c:if></span></td>
		        </tr>
		         <tr>  
		            <td>监管人员指定</td>
		            <td><a href="javascript:void(0);" class="easyui-linkbutton" data-options="iconCls:'fi-torso icon-blue',plain:true" onclick="assigner('${culprit.id}')"><strong>监管人员</strong></a></td>   
		        	<td><span style="color:red;" name="finish" id="finshInfo9"><c:if test="${culprit.finshInfo9==1 }">已完成</c:if></span></td>
		        </tr>
		        <tr>   
		            <td>建立矫正方案</td>
		            <td><a href="javascript:void(0);" class="easyui-linkbutton" data-options="iconCls:'fi-pencil icon-blue',plain:true" onclick="scheme('${culprit.id}')"><strong>录入</strong></a></td>   
		        	<td><span style="color:red;" name="finish" id="finshInfo5"><c:if test="${culprit.finshInfo5==1 }">已完成</c:if></span></td>
		        </tr>
		        <tr>   
		            <td>社区服刑人员入矫宣告书</td>
		            <td><a href="javascript:void(0);" class="easyui-linkbutton" data-options="iconCls:'fi-print icon-blue',plain:true" onclick="printXGS('${culprit.id}')"><strong>打印</strong></a></td>   
		        	<td><span style="color:red;" name="finish" id="finshInfo6"><c:if test="${culprit.finshInfo6==1 }">已完成</c:if></span></td>
		        </tr>
		        <tr>   
		            <td>社区矫正小组责任书</td>
		            <td><a href="javascript:void(0);" class="easyui-linkbutton" data-options="iconCls:'fi-print icon-blue',plain:true" onclick="printZRS('${culprit.id}')"><strong>打印</strong></a></td>   
		        	<td><span style="color:red;" name="finish" id="finshInfo7"><c:if test="${culprit.finshInfo7==1 }">已完成</c:if></span></td>
		        </tr>
		        <tr>   
		            <td>社区矫正志愿者帮教协议书</td>
		            <td><a href="javascript:void(0);" class="easyui-linkbutton" data-options="iconCls:'fi-arrow-up icon-blue',plain:true" onclick="bjxy('${culprit.id}')"><strong>上传</strong></a></td>   
		        	<td><span style="color:red;" name="finish" id="finshInfo8"><c:if test="${culprit.finshInfo8==1 }">已完成</c:if></span></td>
		        </tr> 
		         <tr>   
		            <td>监管等级确定</td>
		            <td><a href="javascript:void(0);" class="easyui-linkbutton" data-options="iconCls:'fi-pencil icon-blue',plain:true" onclick="gradeChange('${culprit.id}')"><strong>变更</strong></a></td>   
		        	<td>（<span id="gradeResult"><c:if test="${culprit.dicMonitorGradeKey ne 27005 }">严管</c:if><c:if test="${culprit.dicMonitorGradeKey eq 27005 }">特殊类监管</c:if></span>）<span style="color:red;">已完成</span></td>
		        </tr>    
		    </tbody>   
			
		</table> 
		<div id="schemeDialog"></div>
		<div id="firstGradeDialog"></div>
		<div id="firstTalkDialog"></div>
		<div id="monitorDialog"></div>
 	<div id="assignerdialog" title="指定人员" modal=true data-options="iconCls:'fi-torso icon-blue'" resizable=true
		class="easyui-dialog" closed=true style="width:400px;padding:5px;">
		<form id="assignerform" action="" method="post">
			<input name="id" type="hidden" id="assignerdialogId" value="${culpritSupervisor.id}"/>
			<input name="culpritId" id="culpritId_assignerdialog" type="hidden"/>
			<table width="100%" class="grid">
				<tr>
					<th width="30%">工作人员：</th>
					<td width="70%"><input id="accountId" name="accountId" class="easyui-combobox"/></td>
					
				</tr>
				<tr>
					<th>协管员：</th>
					<td><input id="assistantId" class="easyui-combobox" name="assistantId"/></td>
				</tr>
				<tr align="center">
					<td colspan="3"><a href="javascript:void(0);" onclick="assignerbtn1()" class="easyui-linkbutton" data-options="iconCls:'icon-save'">保存</a>
						&nbsp; &nbsp;
						<a href="javascript:void(0);" onclick="$('#assignerdialog').dialog('close');" class="easyui-linkbutton" data-options="iconCls:'fi-x icon-blue'">关闭</a></td>
				</tr>
			</table>
		</form>
	</div>
	<div id="bjxydialog" class="easyui-dialog" title="上传协议书" style="width:550px;padding:5px;" modal=true  resizable=true
        data-options="closed:true,iconCls:'fi-arrow-up icon-blue'">
       <form id="saveBjxy">
       <input name="culpritId" type="hidden" value="${culprit.id}"/>
        <table width="100%" class="grid">
        	<tr>
        		<th width="20%">姓名：</th>
        		<td width="80%">${culprit.name }</td>
        	</tr>
        	 <tr>
        		<th>文档编号：</th>
        		<td><input class="easyui-textbox"  name="fileNo"/></td>
        	</tr>
        	<tr>
        		<th>文档类型：</th>
        		<td><input name="dicDocTypeKey"   value="48009" type="hidden">
        			社区矫正志愿者帮教协议书
        		</td>
        	</tr>
        	<tr>
        		<th>文书上传：</th>
        		<td><div id="legalDocsUpload"></div>
	     				<input type="hidden" name="name" id="legalDocsPathName" >
						<input type="hidden" name="path" id="legalDocsPath" >
				</td>
        	</tr>
         </table>
         </form>
         <div align="center" padding="20px 30px 40px 50px">
         <p colspan="4" > 
         <a  href="javascript:void(0)" class="easyui-linkbutton" onclick="saveBjxy()" data-options="iconCls:'icon-save'" >保存</a>
		  			&nbsp;&nbsp;
		  <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'fi-x icon-blue'" onclick="$('#saveBjxy').form('clear'); $('#bjxydialog').dialog('close');">关闭</a>
		  			
		  </p>
    	</div>
	</div> 
<div id="culpritApply"></div>
<script type="text/javascript">
var culpritSupervisorId="${culpritSupervisor.id}";
$(function(){
	/* $('#detail').click(
		function(){
			var id="${culprit.id}";
			open_layer('社区人员基本信息','${ctx}/culpritinfo/culprit/detail?id=' + id);
		
		}); */
});

function iface(id){
	$.ajax({
		type : 'post',
		url : '${ctx}/culpritinfo/culprit/updateFinshInfo?id='+id+'&finshInfo1=1',
		dataType : 'json',
		cache : false,
		async : false, //同步请求
		success : function(result) {
			$('#finshInfo1').html('已完成');
		},
		error : function(result) {
			
		}
	});
}

//编辑个人资料
function updateInformation(id) {
	/* 将自建的div先clone，在close时将克隆的div重新append到页面上。 */
	var dialogParent = $('#culpritApply').parent();  
    var dialogOwn = $('#culpritApply').clone();  
    dialogOwn.hide();  
	 $('#culpritApply').dialog({ 
			 onClose : function() {
				 dialogOwn.appendTo(dialogParent);  
	             $(this).dialog("destroy").remove();
	         },
		    title: '录入个人资料',    
		    width : sy.getBrowerWidth() - 250,
			height : sy.getBrowerHeight() - 150,
			iconCls : 'fi-pencil icon-blue',
			
		    resizable:true,
	        maximizable:true,
		    href : '${ctx}/dailymgr/fileManagement/update?id='+id,
		    modal: true   
		}); 
	 
	  $.ajax({
			type : 'post',
			url : '${ctx}/culpritinfo/culprit/updateFinshInfo?id='+id+'&finshInfo3=1',
			dataType : 'json',
			cache : false,
			async : false, //同步请求
			success : function(result) {
				$('#finshInfo3').html('已完成');
			},
			error : function(result) {
				
			}
		}); 
}


//指定人员
function assigner(id){
	//读取下拉工作人员列表
	$('#accountId').combobox({    
	    url:'${ctx}/sys/sysAccount/findSysAccount?groupId='+'${culprit.groupId}',    
	    valueField:'id',    
	    textField:'accountname',
	    panelHeight:'auto',
	    limitToList:true
	}); 
	$('#assistantId').combobox({    
	    url:'${ctx}/sys/sysAccount/findSysAccount?groupId='+'${culprit.groupId}',    
	    valueField:'id',    
	    textField:'accountname',
	    panelHeight:'auto',
	    multiple:true,
	    limitToList:true
	}); 
	//$('#assignerform').get(0).reset();
	$("#assignerform input[name='id']").attr("value","");
	$('#assignerdialogId').val(culpritSupervisorId);
	$('#culpritId_assignerdialog').val(id);
	$('#assignerdialog').dialog('open');
};

//录入矫正小组
function monitor(culpritId){
	$('#monitorDialog').dialog({
		href:"${ctx}/culpritinfo/Monitor/addMonitor?culpritId=" + culpritId,
		title:'矫正小组录入',
		width : sy.getBrowerWidth() - 400,
	    height :600,
	    iconCls:'fi-pencil icon-blue',
		shadow:false,
	    modal:true,
	    resizable:true,
        maximizable:true,
        loadingMessage:'加载中...',
        buttons:[{
        	 text : '关闭',
             iconCls:'fi-x icon-blue',
             handler : function() {
             	$('#monitorDialog').dialog('close');
             }
        }]
	});
	$('#monitorDialog').window('center');

};



//保存指定人员
	function assignerbtn1(){
		$.ajax({
			type : 'post',
			url : '${ctx}/culpritinfo/culprit/saveSupervisor',
			cache : false,
			data : $('#assignerform').serialize(),
			dataType : 'json',
			success : function(result) {
				//1 关闭窗口
				$('#assignerform').form('clear');
				$('#assignerdialog').dialog('close');
				//$('#assignerdialogId').val(result.data);
				//$('#adjustdialogId').val(result.data);
				culpritSupervisorId=result.data;
				//3 提示信息
				$.messager.show({
					title : result.status == 200 ? "ok" : "fail",
					msg :'保存成功！'
				});
				$.ajax({
					type : 'post',
					url : '${ctx}/culpritinfo/culprit/updateFinshInfo?id=${culprit.id}&finshInfo9=1',
					dataType : 'json',
					cache : false,
					async : false, //同步请求
					success : function(result) {
						$('#finshInfo9').html('已完成');
					},
					error : function(result) {
						
					}
				});
			},
			error : function(result) {
				$.meesager.show({
					title : result.status == 200 ? "ok" : "fail",
					msg : result.msg
				});
			}
		});
	};
	
	/* //保存矫正小组
	function adjustbtn1(){
		$.ajax({
			type : 'post',
			url : '${ctx}/culpritinfo/culprit/saveSupervisor',
			cache : false,
			data : $('#adjustform').serialize(),
			dataType : 'json',
			success : function(result) {
				//1 关闭窗口
				$('#adjustform').form('clear');
				$('#adjustdialog').dialog('close');
				//$('#assignerdialogId').val(result.data);
				//$('#adjustdialogId').val(result.data);
				culpritSupervisorId=result.data;
				//3 提示信息
				$.messager.show({
					title : result.status == 200 ? "ok" : "fail",
					msg : result.msg
				});
				$.ajax({
					type : 'post',
					url : '${ctx}/culpritinfo/culprit/updateFinshInfo?id=${culprit.id}&finshInfo4=1',
					dataType : 'json',
					cache : false,
					async : false, //同步请求
					success : function(result) {
						$('#finshInfo4').html('已完成');
					},
					error : function(result) {
						
					}
				});
			},
			error : function(result) {
				$.meesager.show({
					title : result.status == 200 ? "ok" : "fail",
					msg : result.msg
				});
			}
		});
	};	 */
	
//新增矫正方案
function scheme(culpritId){
	$('#schemeDialog').dialog({
		href:"${ctx}/sys/scheme/addScheme?culpritId=" + culpritId,
		title:'矫正方案录入',
		width : sy.getBrowerWidth() - 400,
	    height :600,
	    iconCls:'fi-pencil icon-blue',
		shadow:false,
	    modal:true,
	    resizable:true,
        maximizable:true,
        loadingMessage:'加载中...',
        buttons:[{
        	 text : '关闭',
             iconCls:'fi-x icon-blue',
             handler : function() {
             	$('#schemeDialog').dialog('close');
             }
        }]
	});
	$('#schemeDialog').window('center');
}
 /* //监管等级
function gradeChange(culpritId){
	$.messager.confirm(
	 '提示信息',
	 '该矫正对象首次报到各事项是否都完成？',
	 function(r){
		if (r){
			$('#firstGradeDialog').dialog({
				href:"${ctx}/dailymgr/gradeChange/firstGrade?culpritId=" + culpritId,
				title:'监管等级信息',
				width : sy.getBrowerWidth()-250,
			    height : sy.getBrowerHeight()-150,
				shadow:false,
			    modal:true,
		        loadingMessage:'加载中...'
			});
		}

	});
	
}  */



var grade='${culprit.dicMonitorGradeKey}';
//监管等级
function gradeChange(id){
	if(grade!=''){
		if(grade=='27005'){
			grade='27004';
			$('#gradeResult').html('严管');	
		}else{
			grade='27005';
			$('#gradeResult').html('特殊类监管');	
		}
	}else{
		grade='27005';
		$('#gradeResult').html('特殊类监管');	
	}	

	$.ajax({
		type : 'post',
		url : '${ctx}/culpritinfo/culprit/updateFinshInfo?id='+id+'&dicMonitorGradeKey='+grade,
		cache : false,
		async : false, //同步请求
		dataType : 'json',
		success : function(result) {
			if(result.status==200){
			$.messager.show({
				title : '提示信息!',
				msg : '修改完成!'
			});	
			}
		}
	});

	
} 



//首次谈话教育
function firstTalk(culpritId){
	$('#firstTalkDialog').dialog({
		href:"${ctx}/culpritinfo/culprit/firstTalkForm?culpritId=" + culpritId,
		title:'首次谈话记录',
		width : sy.getBrowerWidth()-300,
	    height : sy.getBrowerHeight()-150,
	    iconCls:'fi-pencil icon-blue',
	    resizable:true,
        maximizable:true,
		shadow:false,
	    modal:true,
        loadingMessage:'加载中...'
	});
	
}

//打印社区矫正责任书
function printZRS(id){
	$.ajax({
		type : 'post',
		url : '${ctx}/culpritinfo/culprit/updateFinshInfo?id='+id+'&finshInfo7=1',
		dataType : 'json',
		cache : false,
		async : false, //同步请求
		success : function(result) {
			$('#finshInfo7').html('已完成');
		},
		error : function(result) {
			
		}
	});
	
	$('#schemeDialog').dialog({
		href:"${ctx}/culpritinfo/culprit/printZRS?id=" + id,
		title:'打印《社区矫正小组责任书》',
		iconCls:'fi-print icon-blue',
		width : 800,
	    height : 600,
		shadow:false,
	    modal:true,
	    resizable:true,
        maximizable:true,
        loadingMessage:'加载中...',
        buttons :[{
			text:'打印',
            iconCls:'fi-print icon-blue',
			handler:function(){
				$('#sqjzzrs_printBtn').click();
			}
		}, {
			text:'关闭',
			iconCls:'fi-x icon-blue',
			handler:function(){
				$('#schemeDialog').dialog('close');
			}
		}]
	});
	
	$('#schemeDialog').window('center');
	
}

//打印社区矫正宣告书
function printXGS(id){
	/* //检查是否已建立矫正小组
	 $.ajax({
		type : 'post',
		url : '${ctx}/culpritinfo/culprit/checkSupervisor?id='+culpritSupervisorId,
		dataType : 'json',
		cache : false,
		async : false, //同步请求
		success : function(result) {
			if(result.status==505){
				alert(result.msg);
				return;
			}else{	 */
				$.ajax({
					type : 'post',
					url : '${ctx}/culpritinfo/culprit/updateFinshInfo?id='+id+'&finshInfo6=1',
					dataType : 'json',
					cache : false,
					async : false, //同步请求
					success : function(result) {
						$('#finshInfo6').html('已完成');
					},
					error : function(result) {
						
					}
				});
				
				$('#schemeDialog').dialog({
					href:"${ctx}/culpritinfo/culprit/printXGS?id=" + id,
					title:'打印《社区服刑人员入矫宣告书》',
					width : 800,
				    height : 600,
				    resizable:true,
			        maximizable:true,
			        iconCls:'fi-print icon-blue',
					shadow:false,
				    modal:true,
			        loadingMessage:'加载中...',
			        buttons :[{
						text:'打印',
			            iconCls:'fi-print icon-blue',
						handler:function(){
							$('#sqjzxgs_PrintBtn').click();
						}
					}, {
						text:'关闭',
						iconCls:'fi-x icon-blue',
						handler:function(){
							$('#schemeDialog').dialog('close');
						}
					}]
				});	
				
				$('#schemeDialog').window('center');
		/* 	}
		}
	}); 
	 */
	
	
	
}

//上传帮教协议
function bjxy(id){
	if(!hasOpen1){
		$("#legalDocsUpload").empty();
  		$("#legalDocsUpload").powerWebUpload({ auto: true,fileNumLimit:4,serverPath:'${ctx}/servlet/file/upload',fileType:'doc,xls,docx,xlsx,pdf'});	
  	}
	$('#bjxydialog').dialog('open');
	hasOpen1=true;
};

//保存协议书
function saveBjxy(){
	 setFilePathAndName('legalDocsUpload');
	 if($("#saveBjxy").form('validate')){
			$.ajax({
				type: 'post' ,
				url: '${ctx}/culpritinfo/culpritDoc/save',
				cache:false ,
				async : false, //同步请求
				data:$('#saveBjxy').serialize() ,
				dataType:'json',
				success:function(data){
					$.messager.show({
	  					title:'提示信息!',
	  					msg:data.msg
	  				});
					$('#bjxydialog').dialog('close');
					$('#saveBjxy').form('clear'); 
					
					$.ajax({
						type : 'post',
						url : '${ctx}/culpritinfo/culprit/updateFinshInfo?id=${culprit.id}&finshInfo8=1',
						dataType : 'json',
						cache : false,
						async : false, //同步请求
						success : function(result) {
							$('#finshInfo8').html('已完成');
						},
						error : function(result) {
							
						}
					});
				} ,
				error:function(data){
					$.messager.show({
	  					title:'提示信息!',
	  					msg:data.msg
	  				});
				}
			});
		}else{
			 $.messager.show({
				title:'提示信息!' ,
				msg:'验证失败！请检查数据是否已填写完整!'
			}); 
		} 
}	
	
</script>
</body>

