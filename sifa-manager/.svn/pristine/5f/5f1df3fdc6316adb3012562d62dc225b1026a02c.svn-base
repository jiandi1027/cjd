<%@ page language="java" import="java.util.*" pageEncoding="UTF-8"%>
<%@ include file="/WEB-INF/views/include/taglib.jsp"%>
<script type="text/javascript">
	$(function() {
		$('#searchbtn').click(
				function() {
					$('#t_list_examinationAndApproval').datagrid('load',
							$.serializeObject($('#searchForm')));
				});

		function cleanSearch() {
			$('#t_list_content').datagrid('load', {});
			$('#searchForm').form().find('input').val('');
		}
	});


	function viewProcess(url) {
		parent.$.modalDialog({
			title : '流程信息',
			iconCls : 'fi-plus icon-green',
			width : sy.getBrowerWidth() - 250,
			height : sy.getBrowerHeight() - 150,
			href : url
		});
	}


	//详细
	function dealDetail(recordId,type){
		
		var title=sy.getDicValue('common_table','processType',type,'')+'详情';
		
		var href='';
		var buttons='';
		if(type=="95009"){//表扬
			href='${ctx}/jiangcheng/commend/detail?id='+recordId
		}else if(type=="95002"){
			
		}else if(type=="95015"){//迁出
			href='${ctx}/endcorrect/outof/detail?id='+recordId
		}else if(type=="95003"){
			
		}else if(type=="95004"){
			
		}else if(type=="95005"){//提请撤销缓刑详情
			href='${ctx}/jiangcheng/revokeProbation/detail?id='+recordId;
		}else if(type=="95006"){//提请撤销假释详情
			href='${ctx}/jiangcheng/revokeParole/detail?id='+recordId;
		}else if(type=="95007"){//提请撤销监外执行详情
			href='${ctx}/jiangcheng/revokeOutOfPrison/detail?id='+recordId;
		}else if(type=="95008"){
			
		}else if(type=="95009"){
			
		}else if(type=="95010"){
			
		}else if(type=="95011"){//延长监外执行详情
			href='${ctx}/dailymgr/outOfPrison/detail?id='+recordId;
		}else if(type=="95012"){
			
		}else if(type=="95013"){//进入特定区域详情
			href='${ctx}/dailymgr/specialArea/detail?id='+recordId;
		}else if(type=="95014"){//脱管管理详情
			href='${ctx}/endcorrect/detached/detail?id='+recordId;
		}
		 parent.$.modalDialog({
	         title : title,
	         iconCls:'fi-plus icon-green',
	         width : sy.getBrowerWidth()-250,
	         height : sy.getBrowerHeight()-150,
	         href : href,
	         buttons : [ {
	             text : '返回',
	             iconCls:'fi-arrow-left',
	             handler : function() {
	            	 parent.$.modalDialog.handler.dialog('close');
	             }
	         }]
	     });

	}
	
	//流程审批
	function dealSubmitAudit(taskId,recordId,auditType,processId,type){
		var href='';
		var formName='';
		if(type=="95009"){//表扬
			href="${ctx}/jiangcheng/commend/commendAudit?id="+ recordId+"&taskId="+taskId+"&auditType="+auditType+"&processInstanceId="+processId;
			formName='askLeaveAuditForm';
		}else if(type=="95002"){
			
		}else if(type=="95003"){
		
		}else if(type=="95015"){//迁出管理
			href="${ctx}/endcorrect/outof/submitAskLeaveAudit?id="+ recordId+"&taskId="+taskId+"&auditType="+auditType+"&processInstanceId="+processId;
		}else if(type=="95004"){
			
		}else if(type=="95005"){//提请撤销缓刑处理
			href="${ctx}/jiangcheng/revokeProbation/revokeProbationAudit?id="+ recordId+"&taskId="+taskId+"&auditType="+auditType+"&processInstanceId="+processId;
			formName='revokeProbationAuditForm';
		}else if(type=="95006"){//提请撤销假释处理
			href="${ctx}/jiangcheng/revokeParole/revokeParoleAudit?id="+ recordId+"&taskId="+taskId+"&auditType="+auditType+"&processInstanceId="+processId;
			formName='revokeParoleAuditForm';
		}else if(type=="95007"){//提请撤销监外执行处理
			href="${ctx}/jiangcheng/revokeOutOfPrison/revokeOutOfPrisonAudit?id="+ recordId+"&taskId="+taskId+"&auditType="+auditType+"&processInstanceId="+processId;
			formName='revokeOutOfPrisonAuditForm';
		}else if(type=="95008"){
			
		}else if(type=="95009"){
			
		}else if(type=="95010"){
			
		}else if(type=="95011"){
			href="${ctx}/dailymgr/outOfPrison/outOfPrisonAudit?id="+ recordId+"&taskId="+taskId+"&auditType="+auditType+"&processInstanceId="+processId;
			formName='outOfPrisonAuditForm';
		}else if(type=="95012"){
			
		}else if(type=="95013"){//进入特定区域管理处理
			href="${ctx}/dailymgr/specialArea/specialAreaAudit?id="+ recordId+"&taskId="+taskId+"&auditType="+auditType+"&processInstanceId="+processId;
			formName='specialAuditForm';
		}else if(type=="95014"){
			href='${ctx}/endcorrect/detached/detachedAudit?id='+ recordId+"&taskId="+taskId+"&auditType="+auditType+"&processInstanceId="+processId;
			formName='detachedAuditForm';
		}
		parent.$.modalDialog({
	        title : '流程审批',
	        iconCls:'fi-plus icon-green',
	        width : sy.getBrowerWidth()-500,
	        height : sy.getBrowerHeight()-300,
	        href : href,
	        buttons : [ {
	            text : '提交',
	            iconCls:'icon-save',
	            handler : function() {
	                parent.$.modalDialog.openner_dataGrid = $('#t_list_examinationAndApproval').datagrid();//因为添加成功之后，需要刷新这个dataGrid，所以先预定义好
	                var f=parent.$.modalDialog.handler.find('#'+formName);
	                f.submit();
	            }
	        },{
	        	text : '返回',
	            iconCls:'fi-arrow-left',
	            handler : function() {
	           		 parent.$.modalDialog.handler.dialog('close');
	            }
	        }  ]
	    });
	}
	
	
	
	
	function stopProcess(taskId) {
		$.messager.confirm('提示', '请判断是否要执行该操作?', function(b) {
			if (b) {
				$.ajax({
					type : 'get',
					url : "${ctx}/todo/examinationAndApproval/stopProcess?taskId="
							+ taskId,
					cache : false,
					async : false, //同步请求
					dataType : 'json',
					success : function(result) {
						if(result.status==200){
		  					$.messager.show({
			  					title : '提示信息!',
			  					msg : '终止成功!'
			  				});
		  				}
		  				$('#t_list_examinationAndApproval').datagrid('reload',{});

					}
				});

			}
		});

	}


	
	//操作
	function formatOper(val,row,index){  
		var operation='<a href="javascript:void(0);" onclick="dealDetail(\''+row.recordId+'\',\''+row.type+'\')">详情</a>';
		if(row.hasPermission==1){
			operation=operation+'&nbsp;&nbsp;|&nbsp;&nbsp;<a href="javascript:void(0);" onclick="dealSubmitAudit(\''+row.taskId+'\',\''+row.recordId+'\',\''+row.auditType+'\',\''+row.processInstanceId+'\',\''+row.type+'\')">处理</a>';
		}
		if(row.processInstanceId!='' && row.processInstanceId!=null){
			var processDetailUrl='';
			if(row.type=="95009"){//表扬
				processDetailUrl="/jiangcheng/commend/forProcessDetail?id="+row.recordId;
			}else if(row.type=="95002"){
				
			}else if(row.type=="95003"){
				
			}else if(row.type=="95004"){
				
			}else if(row.type=="95005"){//撤销缓刑查看流程图
				processDetailUrl="/endcorrect/detached/forProcessDetail?id="+row.recordId;
			}else if(row.type=="95006"){//撤销假释查看流程图
				processDetailUrl="/jiangcheng/revokeParole/forProcessDetail?id="+row.recordId;
			}else if(row.type=="95007"){//撤销暂予监外执行查看流程图
				processDetailUrl="/jiangcheng/revokeProbation/forProcessDetail?id="+row.recordId;
			}else if(row.type=="95008"){
				
			}else if(row.type=="95009"){
				
			}else if(row.type=="95015"){//迁出管理
				processDetailUrl="/endcorrect/outof/forProcessDetail?id="+row.recordId;
				
			}else if(row.type=="95011"){//延长监外执行查看流程图
				processDetailUrl="/dailymgr/outOfPrison/forProcessDetail?id="+row.recordId;
			}else if(row.type=="95012"){
				
			}else if(row.type=="95013"){//进入特定区域查看流程图
				processDetailUrl="/dailymgr/specialArea/forProcessDetail?id="+row.recordId;
			}else if(row.type=="95014"){//脱管管理
				processDetailUrl="/endcorrect/detached/forProcessDetail?id="+row.recordId;
			}
			
			if(row.isEnd==1){
				var url = '${ctx}/flow/forQueryProcessDefinitionResource?processDefinitionId='+row.processDefinitionId+'&resourceType=png';
				operation=operation+'&nbsp;&nbsp;|&nbsp;&nbsp;<a href="javascript:void(0);" onclick="viewProcess(\''+url+'&processDetailUrl='+processDetailUrl+'\')">查看流程图</a>';
			}else{
				var url = '${ctx}/flow/queryActivityMap?processInstanceId='+row.processInstanceId;
				operation=operation+'&nbsp;&nbsp;|&nbsp;&nbsp;<a href="javascript:void(0);" onclick="viewProcess(\''+url+'&processDetailUrl='+processDetailUrl+'\')">查看流程图</a>';
			}
		}
		if(row.processInstanceId!='' && row.processInstanceId!=null){
		
			if(row.isEnd==0){
				operation=operation+'&nbsp;&nbsp;|&nbsp;&nbsp;<a href="javascript:void(0);" onclick="stopProcess(\''+row.taskId+'\')">终止</a>';
			}
		}
	    return operation;
	} 
</script>

<div class="easyui-layout" data-options="fit:true,border:false">
	
		<div data-options="region:'east',border:true,split:false" style="width: 240px;">
		<div class="easyui-layout" data-options="fit:true,border:false">
		   <div class="easyui-panel search-form" data-options="fit:true,border:false" id="p2" title="查询项目" style="width:100%;">
	        <form id="searchForm"  style="padding-bottom: 10px;padding-top: 10px;">
				<table>
					<tr>
						<td width="35%" align="right">类&nbsp;&nbsp;&nbsp;&nbsp;别：</td>
						<td>
							<select id="type" class="easyui-combobox" name="judicialOffices"  id="judicialOffices"
							style="width: 170px;" >
									<option value=""></option>
									<option value="所有">所有</option>
									<%-- <c:forEach var="sysdic" items="${sysdicList }">
									<option value="${sysdic.key }">${sysdic.value }</option>
									</c:forEach> --%>
									<option value="所有">所有</option>
									<option value="审前调查">审前调查</option>
									<option value="请销假管理">请销假管理</option>
									<option value="延长监外执行">延长监外执行</option>
									<option value="口头警告">口头警告</option>
									<option value="警告处罚">警告处罚</option>
									<option value="提请治安管理处罚">提请治安管理处罚</option>
									<option value="提请撤销缓刑">提请撤销缓刑</option>
									<option value="提请撤销假释">提请撤销假释</option>
									<option value="减刑申请">减刑申请</option>
									<option value="死亡登记">死亡登记</option>
									<option value="迁入申请">迁入申请</option>
									<option value="迁出申请">迁出申请</option>
									<option value="假释申请">假释申请</option>
									<option value="漏罪申请">漏罪申请</option>
									<option value="期满解矫">期满解矫</option>
									<option value="进入特定区域申请">进入特定区域申请</option>
									<option value="脱管管理">脱管管理</option>
									<option value="月度考评">月度考评</option>
					</select>
						</td>
					</tr>
					<tr>
						<td width="35%" align="right">姓&nbsp;&nbsp;&nbsp;&nbsp;名：</td>
						<td><input name="culpritName" id="culpritName"
						class="easyui-textbox" style="width: 170px;"  /></td>
					</tr>

				</table>
			</form>
			</div>
			<div data-options="region:'south',border:false" style="height: 30px;line-height:30px; overflow: hidden;text-align: center;background-color: #eee" >
				<a href="#" class="easyui-linkbutton" id="searchbtn" iconCls="icon-search" >搜索</a> &nbsp;&nbsp; 
				<a href="#" class="easyui-linkbutton" id="cleanGroupBtn" iconCls="icon-undo" onclick="javascript:$('#t_list_announcement').form('clear');">清空</a>
			</div>
		</div>
	</div>
	<div data-options="region:'center',border:true">
		<table class="easyui-datagrid" id="t_list_examinationAndApproval" title="待审批列表" 
			data-options="singleSelect:true,fit:true,fitColumns:true,collapsible:true,striped:true,loadMsg: '数据正在加载,请耐心的等待...' ,pagination:true,pageSize: 10 ,pageList:[5,10,15,20,50],url:'${ctx}/todo/examinationAndApproval/list',method:'post'">
			<thead>
				<tr>
					<th data-options="field:'id',checkbox:true,width:'10%'">编号</th>
					<th data-options="field:'culpritName',width:'15%',align:'center'">对象姓名</th>
					<th data-options="field:'judicialOffices',width:'15%',align:'center'">申请司法所</th>
					<th data-options="field:'type',width:'15%',align:'center',formatter:function(value,rowData,rowIndex){    
    	 return sy.getDicValue('common_table','processType',rowData.type,''); }">审批类型</th>
					<th data-options="field:'taskDate',width:'15%',align:'center',sortable:true">任务产生时间</th>
					<th data-options="field:'activityName',width:'10%',align:'center'">审批状态</th>
					<!-- <th data-options="field:'correctDate',width:'15%',align:'center',sortable:true">矫正期满时间</th> -->
					<th data-options="field:'_opt',align:'center',width:'27%',formatter:formatOper">操作</th>

				</tr>
			</thead>
		</table>
	</div>
</div>

