<%@ page language="java" import="java.util.*" pageEncoding="UTF-8"%>
<%@ include file="/WEB-INF/views/include/taglib.jsp"%>
<script type="text/javascript">
	var flag; //undefined 判断新增和修改方法
	var toolbar = [ {
		text : '新增',
		iconCls : 'fi-plus icon-green',
		handler : function() {
			 parent.$.modalDialog({
		         title : '新增死亡登记',
		         iconCls:'fi-plus icon-green',
		         width : sy.getBrowerWidth()-250,
		         height : sy.getBrowerHeight()-150,
		         href : '${ctx}/endcorrect/death/add',
		         buttons : [ {
		             text : '保存',
		             iconCls:'fi-save icon-blue',
		             handler : function() {
		                 parent.$.modalDialog.openner_dataGrid = $('#death_list_content').datagrid();//因为添加成功之后，需要刷新这个dataGrid，所以先预定义好
		                 var f = parent.$.modalDialog.handler.find('#deathAddform');
		                 f.submit();
		             }
		         }
		         ]
		     });
		}

	},  '-', {
		text : '批量删除',
		iconCls : 'fi-x icon-red',
		handler : function() {
			var arr = $('#death_list_content').datagrid('getSelections');
			if (arr.length <= 0) {
				$.messager.show({
					title : '提示信息!',
					msg : '至少选择一行记录进行删除!'
				});
			} else {
				$.messager.confirm('提示信息', '确认删除?', function(r) {
					if (r) {
						var ids = '';
						for (var i = 0; i < arr.length; i++) {
							if (i == 0) {
								ids +=arr[i].id
							} else {
								ids += "&ids=" + arr[i].id;
							}

						}
						//ids = ids.substring(0, ids.length - 1);
						$.post('${ctx}/endcorrect/death/batchDelete', {
							ids : ids
						}, function(result) {
							//1 刷新数据表格 
							$('#death_list_content').datagrid('reload');
							//2 清空idField   
							$('#death_list_content').datagrid('uncheckAll');
							//3 给提示信息 
							$.messager.show({
								title : '提示信息!',
								msg : '操作成功!'
							});
						});
					} else {
						return;
					}
				});
			}
		}
	}];
	//js方法：序列化表单 			
	function serializeForm(form) {
		var obj = {};
		$.each(form.serializeArray(),
				function(index) {
					if (obj[this['name']]) {
						obj[this['name']] = obj[this['name']] + ','
								+ this['value'];
					} else {
						obj[this['name']] = this['value'];
					}
				});
		return obj;
	}
	function formatOper(val,row,index){  
		var operation='';
		if(row.processInstanceId!='' && row.processInstanceId!=null){
			var operation='<a href="javascript:void(0);" class="organization-easyui-linkbutton-info" onclick="deathDetail(\''+row.id+'\')"></a>';
		}
		if(row.hasPermission==1){
			operation=operation+'&nbsp;&nbsp;&nbsp;<a href="javascript:void(0);" calss="organization-easyui-linkbutton-clipboard-pencil" onclick="submitAuditDeath(\''+row.taskId+'\',\''+row.id+'\',\''+row.auditType+'\',\''+row.processInstanceId+'\')"></a>';
		}
		if(row.processInstanceId!='' && row.processInstanceId!=null){
			if(row.isEnd==1){
				var url = '${ctx}/flow/queryProcessDefinitionResource?processDefinitionId='+row.processDefinitionId+'&resourceType=png';
				operation=operation+'&nbsp;&nbsp;&nbsp;<a href="javascript:void(0);" class="organization-easyui-linkbutton-map" onclick="viewProcess(\''+url+'\')"></a>';
			}else{
				var url = '${ctx}/flow/queryActivityMap?processInstanceId='+row.processInstanceId;
				operation=operation+'&nbsp;&nbsp;&nbsp;<a href="javascript:void(0);" class="organization-easyui-linkbutton-map" onclick="viewProcess(\''+url+'\')"></a>';
			}
		}
		
	    return operation;
	} 
	function viewProcess(url){
		 parent.$.modalDialog({
	         title : '流程信息',
	         iconCls:'fi-shuffle icon-blue',
	         width : sy.getBrowerWidth()-250,
	         height : sy.getBrowerHeight()-150,
	         resizable : true,
	         maximizable:true, 
	         href : url
	     });
	}
	function submitAuditDeath(taskId,id,auditType,processInstanceId){
		 parent.$.modalDialog({
	         title : '死亡登记审批',
	         iconCls:'fi-plus icon-green',
	         width : sy.getBrowerWidth()-250,
	         height : sy.getBrowerHeight()-150,
	         resizable : true,
	         maximizable:true, 
	         href : '${ctx}/endcorrect/death/deathAudit?id='+id+'&taskId='+taskId+'&auditType='+auditType+'&processInstanceId='+processInstanceId,
	         buttons : [ {
	             text : '同意',
	             iconCls:'icon-save',
	             handler : function() {
	            	 parent.$.modalDialog.openner_dataGrid = $('#death_list_content').datagrid();
	                 var f1 = parent.$.modalDialog.handler.find('#deathAuditForm');
	                 f1.submit(); 
	             }
	         }
	         ]
	     });
	
	}

	function deathDetail(id){
		var url = '${ctx}/endcorrect/death/detail?id=' + id;
		 parent.$.modalDialog({
	         title : '流程信息',
	         iconCls:'fi-info icon-blue',
	         width : sy.getBrowerWidth()-250,
	         height : sy.getBrowerHeight()-150,
	         resizable : true,
	         maximizable:true, 
	         href : url
	     });
		
	}
	function open_layer(title,url){
		
		var index = layer.open({
			type: 2,
			title: title,
			content: url
		});
		layer.full(index);
	}
	</script>

<div class="easyui-layout" data-options="fit:true,border:false">
        <form id="sysAccountSearchForm"  style="padding-bottom: 10px;padding-top: 10px;">
	<div data-options="region:'east',border:true,split:false,title:'查询条件'" style="width: 250px;">
        <div class="easyui-layout" data-options="fit:true,border:false">
        <div region="center" border="false">
         	<c:if test="${!fns:isLeafGroup(fns:getSysAccount().groupId) }">
					<sys:sysGroup hiddenId="sfsGroupId" hiddenName="sfsGroupId" dataGridId="talkform"/>
		        </c:if>
		        <div class="easyui-panel search-form" data-options="fit:true,border:false" id="p2" title="<c:if test="${!fns:isLeafGroup(fns:getSysAccount().groupId) }">查询项目 </c:if>" style="width:100%;">
			<table>
				<tr>
				<td class="search-title">矫正人员：</td>
					<td><input name="culpritName" class="easyui-textbox" /></td>
				</tr>
			</table></div>
		</div>
		 <div data-options="region:'south',border:false" style="height: 30px;line-height:30px; overflow: hidden;text-align: center;background-color: #eee" ><a
						href="#" class="easyui-linkbutton" iconCls="icon-search" onclick="javascript:$('#death_list_content').datagrid('load' ,$.serializeObject($('#sysAccountSearchForm')));"
						id="searchGroupBtn">搜索</a> &nbsp;&nbsp; <a href="#"
						class="easyui-linkbutton" id="cleanGroupBtn" iconCls="icon-undo" onclick="javascript:$('#sysAccountSearchForm').form('clear');">清空</a></div>
		</div>
	</div>
		</form>
	<div region="center" border="false">
		<table class="easyui-datagrid" id="death_list_content" title="死亡登记列表"
			style="height: 400px;"
			data-options="singleSelect:true,fit:true,collapsible:true,striped:true,toolbar:toolbar,
			loadMsg: '数据正在加载,请耐心的等待...' ,pagination:true,pageSize: 10 ,pageList:[5,10,15,20,50],fitColumns:true
			,url:'${ctx}/endcorrect/death/list',method:'post',onLoadSuccess:function (data) {
                        $('.organization-easyui-linkbutton-info').linkbutton({text:'详情',plain:true,iconCls:'fi-info icon-blue'});
                        $('.organization-easyui-linkbutton-map').linkbutton({text:'流程图',plain:true,iconCls:'fi-shuffle icon-blue'});
                        $('.organization-easyui-linkbutton-stop').linkbutton({text:'终止',plain:true,iconCls:'fi-power icon-red'});
                        $('.organization-easyui-linkbutton-clipboard-pencil').linkbutton({text:'处理',plain:true,iconCls:'fi-clipboard-pencil icon-blue'});
                    }">
			<thead>
				<tr>
					<th data-options="field:'id',checkbox:true,width:80"></th>
					<th data-options="field:'culpritName',width:80,align:'center'"
						editor="text">姓名</th>
					<th data-options="field:'groupName',width:100,align:'center'"
						editor="text" ">司法所</th>
					<th style="width: 10%;"
						data-options="field:'deathlTime',width:80,align:'center',sortable:true"
						editor="{type:'validatebox',options:{required:true}}">死亡时间</th>
					<th data-options="field:'deathReason',width:250,align:'center'"
						editor="text">死亡原因</th>
					<th data-options="field:'situation',width:250,align:'center'"
						editor="text">死亡相关情况</th>
						<th data-options="field:'activityName',width:250,align:'center'"
						editor="text">流程状态</th>
						<th data-options="field:'_opt',width:200,align:'center',formatter:formatOper">操作</th>  

				</tr>
			</thead>
		</table>
	</div>
	<div id="mydialog" title="新增死亡登记" modal=true draggable=false
		class="easyui-dialog" closed=true style="width: 600px;">
		<form id="myform" action="" method="post">
			<div id="tabAdd" class="easyui-tabs">
				<div title="基本信息" data-options="iconCls:'icon-view'"
					style="padding: 5px 5px">
					<input type="hidden" name="id" value="" />
					<table>
						<tr>
							<td>矫正对象:</td>
							<td><input id="addCulpritId" name="culpritId" class="easyui-combobox"
								url="${ctx}/culpritinfo/culprit/findAll" valueField="id"
								textField="name" value="" /></td>
							<td>死亡时间:</td>
							<td><input id="addDeathlTime" name="deathlTime"
								class="easyui-validatebox" onFocus="WdatePicker({dateFmt:'yyyy-MM-dd HH:mm:ss'})"/></td>

						</tr>
						<tr>
				
							<td>死亡原因:</td>
							<td><input id="addDeathReason" type="text" name="deathReason"
								class="easyui-validatebox" /></td>

							<td>死亡相关情况:</td>
							<td><input id="addsituation" type="text" name="situation"
							class="easyui-validatebox"/>
								</td>
							
						</tr>
					<tr align="center">
							<td colspan="2"><a id="btn1" class="easyui-linkbutton">确定</a>
								<a id="btn2" class="easyui-linkbutton">关闭</a></td>
						</tr>
					</table>
				</div>
					
			</div>
		</form>
	</div>
</div>

