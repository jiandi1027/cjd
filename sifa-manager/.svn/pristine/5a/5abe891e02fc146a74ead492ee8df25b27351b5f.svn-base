<%@ page language="java" import="java.util.*" pageEncoding="UTF-8"%>
<%@ include file="/WEB-INF/views/include/taglib.jsp"%>

<form  action="" method="post" id="moveInAddInfo">
	 <div class="easyui-panel" title="基本信息" style="width:100%;padding:5px;">
		<input type="hidden" name="id" value="" />
			<table width="100%" class="grid">
				<tr>
					<th width="10%"><span class="c-red">*</span>姓名：</th>
					<td width="23%" style="border-right-style:none"><input type="text" name="name" required=true
						class="easyui-textbox" /></td>
					<td width="10%" style="border-style:none"></td>
					<td width="23%" style="border-style:none"></td>
					<td width="10%" style="border-style:none"></td>
					<td width="23%" style="border-style:none"></td>
				</tr>
				<tr>
					<th width="10%"><span class="c-red">*</span>身份证号：</th>
					<td width="23%"><input type="text" name="cedentialsNumber"  data-options="required:true,missingMessage:'请输入身份证',validType:'idcared'"
						class="easyui-textbox" /></td>
					<th width="10%">性别：</th>
					<td width="23%"><input name="dicSexKey" id="dicSexKey" class="easyui-combobox" required=true value="10001"
                  	data-options="valueField:'id',textField:'value',url:'${ctx}/sys/sysDic/getDicOnlyByParent?parentKey=10000',panelHeight:'auto',editable:false"></input></td>
					<th width="10%">民族：</th>
					<td width="23%"><input name="nation" id="nation" class="easyui-combobox" value="104001"
                  		data-options="valueField:'id',textField:'value',url:'${ctx}/sys/sysDic/getDicOnlyByParent?parentKey=104000',panelHeight:'130',editable:false"></input></td>
				</tr>
				<tr>
					<th>曾用名：</th>
					<td><input type="text" name="alias"
						class="easyui-textbox" /></td>
					
					<th><span class="c-red">*</span>出生日期：</th>
					<td><input name="bornDate" required=true class="Wdate easyui-validatebox" 
					onclick="WdatePicker({readOnly:true,dateFmt:'yyyy-MM-dd'})"/></td>
					
					<th><span class="c-red">*</span>文化程度：</th>
					<td><input name="dicWhcdKey"required=true id="dicWhcdKey" class="easyui-combobox"
                  	data-options="valueField:'id',textField:'value',url:'${ctx}/sys/sysDic/getDicOnlyByParent?parentKey=19000',panelHeight:'auto',editable:false"></input></td>
				</tr>
				<tr>
					<th><span class="c-red">*</span>婚姻状况：</th>
					<td><input name="dicHyzkKey" required=true id="dicHyzkKey" class="easyui-combobox" 
                  	data-options="valueField:'id',textField:'value',url:'${ctx}/sys/sysDic/getDicOnlyByParent?parentKey=11000',panelHeight:'auto',editable:false"></input></td>
					<th>职业：</th>
					<td><input type="text" name="job"
						class="easyui-textbox" /></td>
					<th>原政治面貌：</th>
					<td><input name="oldPoliticStatusId"class="easyui-combobox"
                  	data-options="valueField:'id',textField:'value',url:'${ctx}/sys/sysDic/getDicOnlyByParent?parentKey=65000',panelHeight:'auto',editable:false" /></td>
				</tr>
				<tr>
					<th><span class="c-red">*</span>籍贯：</th>
					<td><input type="text" name="origin" required=true
						class="easyui-textbox" /></td>
					<th>户籍所在地：</th>
					<td><input type="text" name="regResidence"
						class="easyui-textbox" /></td>
					<th><span class="c-red">*</span>联系方式：</th>
					<td><input type="text" name="contactPhone" required=true data-options="validType:['phoneNum','telNum']"
						class="easyui-numberbox" /></td>
				</tr>
				<tr>
					<th>原判罪名：</th>
					<td><input type="text" name="crimeInfo"
						class="easyui-textbox" /></td>
					<th><span class="c-red">*</span>刑期：</th>
					<td><input type="text" name="adjudgePeriod"required=true class="easyui-textbox" /></td>
					<th><span class="c-red">*</span>刑期执行类别：</th>
					<td><input type="text" name="dicPenalTypeKey" required=true class="easyui-combobox"
                  	data-options="valueField:'id',textField:'value',url:'${ctx}/sys/sysDic/getDicOnlyByParent?parentKey=20000',panelHeight:'auto',editable:false" /></td>
				</tr>
				<tr>
					<th>刑期变动：</th>
					<td><input type="text" name="adjudgeChange"
						class="easyui-textbox" /></td>
					<th><span class="c-red">*</span>刑期开始日期：</th>
					<td><input name="adjudgeStartTime" id="adjudgeStartTime" required=true class="Wdate easyui-validatebox" 
					onfocus="WdatePicker({dateFmt:'yyyy-MM-dd',maxDate:'#F{$dp.$D(\'adjudgeEndTime\')}'})"/></td>
					<th><span class="c-red">*</span>刑期结束日期：</th>
					<td><input name="adjudgeEndTime" id="adjudgeEndTime" required=true class="Wdate easyui-validatebox" 
					onfocus="WdatePicker({dateFmt:'yyyy-MM-dd',minDate:'#F{$dp.$D(\'adjudgeStartTime\')}',maxDate:'2120-10-01'})"/></td>
				</tr>
				<tr>
					<th><span class="c-red">*</span>矫正期限：</th>
					<td><input type="text" name="redressPeriod" required=true class="easyui-textbox" /></td>
					<th><span class="c-red">*</span>矫正开始日期：</th>
					<td><input name="redressStartDate" id="redressStartDate" required=true class="Wdate easyui-validatebox" 
					onfocus="WdatePicker({dateFmt:'yyyy-MM-dd',maxDate:'#F{$dp.$D(\'redressEndDate\')}'})"/></td>
					<th><span class="c-red">*</span>矫正结束日期：</th>
					<td><input name="redressEndDate" id="redressEndDate" required=true class="Wdate easyui-validatebox" 
					onfocus="WdatePicker({dateFmt:'yyyy-MM-dd',minDate:'#F{$dp.$D(\'redressStartDate\')}',maxDate:'2120-10-01'})"/></td>
				</tr>
			</table>
		</div>
	 <div class="easyui-panel" title="迁入相关信息" style="width:100%;padding:5px;">
	 	<table width="100%" class="grid" >
			<tr>
				<th width="10%"><span class="c-red">*</span>申请时间：</th>
				<td width="23%"><input name="moveTime" required=true class="Wdate easyui-validatebox" value='<fmt:formatDate value="${now}" pattern="yyyy-MM-dd" />'
				 onclick="WdatePicker({readOnly:true,dateFmt:'yyyy-MM-dd'})"/></td>
				<th width="10%"><span class="c-red">*</span>原司法所：</th>
				<td width="23%"><input type="text" name="oldGroup" required=true class="easyui-textbox" /></td>
				<th width="10%"><span class="c-red">*</span>拟迁往司法所：</th>
				<td width="23%"><input name="groupId" required=true class="easyui-combotree"
                  	data-options="url:'${ctx}/sys/sysGroup/loadGroupTree',editable:false"  /></td>
			</tr>
			<tr>
				<th>现居住地：</th>
				<td colspan="5"><input name="addressProId" id="addressProId" class="easyui-combobox" required=true
					value="${moveIn.addressProId}" data-options="valueField:'id',textField:'areaName',limitToList:true,url:'${ctx}/culpritinfo/culprit/findAreaByLevel?areaLevel=1',panelHeight:'200',editable:false"></input>省
					<input name="addressCityId" id="addressCityId" class="easyui-combobox" required=true
					value="${moveIn.addressCityId}" data-options="editable:false,limitToList:true"></input>市
					<input name="addressCountryId" id="addressCountryId" class="easyui-combobox" required=true
					value="${moveIn.addressCountryId}" data-options="editable:false,limitToList:true"></input>县（区）
					<input id="addressStreet" name="addressStreet" class="easyui-textbox" value="${moveIn.addressStreet}">乡镇（街道）
					<input id="addressDetaill" name="addressDetaill" class="f1 easyui-textbox" value="${moveIn.addressDetail}">(详细门牌号)</td>
			</tr>
			<tr>
				<th><span class="c-red">*</span>拟居住地：</th>
				<td colspan="5"><input name="regResidenceProId"
					id="regResidenceProId" class="easyui-combobox" required=true 
					value="${moveIn.regResidenceProId}"
					data-options="valueField:'id',textField:'areaName',limitToList:true,url:'${ctx}/culpritinfo/culprit/findAreaByLevel?areaLevel=1',panelHeight:'200',editable:false"></input>省
					<input id="regResidenceCityId" name="regResidenceCityId" class="easyui-combobox" required=true
					value="${moveIn.regResidenceCityId}" data-options="editable:false,limitToList:true">市
					<input id="regResidenceCountryId" name="regResidenceCountryId" class="easyui-combobox" required=true
					value="${moveIn.regResidenceCountryId}" data-options="editable:false,limitToList:true">县（区）
					 <input id="regResidenceStreet" name="regResidenceStreet"
					class="f1 easyui-textbox" value="${moveIn.regResidenceStreet}">乡镇（街道）
					<input id="regResidenceDetail" name="regResidenceDetail"
					class="f1 easyui-textbox" value="${moveIn.regResidenceDetail}">(详细门牌号)</td>
			</tr>
			<tr rowspan="4">
				<th>居住地变更原因：</th>
				<td colspan="5">
				<textArea id="note" name="reason" class="easyui-validatebox" style="width: 40%;height:60px;overflow:hidden;"
					onkeydown='textarealength(this,300)' onKeyUp="textarealength(this,300)" maxlength="300"></textArea>
					<br>
						备注：此处最多可以输入<em class="c-red">300</em>个字，你已输入<em class="textarea-length c-red">0</em>个字。
				</td>
				</tr>
				<tr>
					<th >相关材料：</th>
					<td colspan="5">
						<div id="uploader"></div>
					</td>
				</tr>
			<tr rowspan="3">
				<th>司法所意见：</th>
				<td colspan="5">
				<textArea id="note" name="opinion" class="easyui-validatebox" style="width: 40%;height:60px;overflow:hidden;"
					onkeydown='textarealength(this,200)' onKeyUp="textarealength(this,200)" maxlength="200"></textArea>
					<br>
						备注：此处最多可以输入<em class="c-red">200</em>个字，你已输入<em class="textarea-length c-red">0</em>个字。
				</td>
				</tr>
				<tr rowspan="3">
				<th>备注：</th>
				<td colspan="5">
				<textArea id="note" name="note" class="easyui-validatebox" style="width: 40%;height:60px;overflow:hidden;"
					onkeydown='textarealength(this,200)' onKeyUp="textarealength(this,200)" maxlength="200"></textArea>
					<br>
						备注：此处最多可以输入<em class="c-red">200</em>个字，你已输入<em class="textarea-length c-red">0</em>个字。
				</td>
				</tr>
		</table>
	 </div>
	</form>
<script type="text/javascript">
$.extend($.fn.validatebox.defaults.rules, {   
    phoneNum: { //验证手机号  
        validator: function(value, param){
         return /^1[3-8]+\d{9}$/.test(value);
        },   
        message: '请输入正确的手机号码。'  
    },
   
    telNum:{ //既验证手机号，又验证座机号
      validator: function(value, param){
          return /(^(0[0-9]{2,3}\-)?([2-9][0-9]{6,7})+(\-[0-9]{1,4})?$)|(^((\d{3})|(\d{3}\-))?(1[358]\d{9})$)/.test(value);
         },   
         message: '请输入正确的电话号码。'
    }  
});
var aCity={11:"北京",12:"天津",13:"河北",14:"山西",15:"内蒙古",21:"辽宁",22:"吉林",23:"黑龙江",31:"上海",32:"江苏",33:"浙江",34:"安徽",35:"福建",36:"江西",37:"山东",41:"河南",42:"湖北",43:"湖南",44:"广东",45:"广西",46:"海南",50:"重庆",51:"四川",52:"贵州",53:"云南",54:"西藏",61:"陕西",62:"甘肃",63:"青海",64:"宁夏",65:"新疆",71:"台湾",81:"香港",82:"澳门",91:"国外"}   

function isCardID(sId){   
    var iSum=0 ;  
    var info="" ;  
    if(!/^\d{17}(\d|x)$/i.test(sId)) return "你输入的身份证长度或格式错误";   
    sId=sId.replace(/x$/i,"a");   
    if(aCity[parseInt(sId.substr(0,2))]==null) return "你的身份证地区非法";   
    sBirthday=sId.substr(6,4)+"-"+Number(sId.substr(10,2))+"-"+Number(sId.substr(12,2));   
    var d=new Date(sBirthday.replace(/-/g,"/")) ;  
    if(sBirthday!=(d.getFullYear()+"-"+ (d.getMonth()+1) + "-" + d.getDate()))return "身份证上的出生日期非法";   
    for(var i = 17;i>=0;i --) iSum += (Math.pow(2,i) % 11) * parseInt(sId.charAt(17 - i),11) ;  
    if(iSum%11!=1) return "你输入的身份证号非法";   
    return true;//aCity[parseInt(sId.substr(0,2))]+","+sBirthday+","+(sId.substr(16,1)%2?"男":"女")   
}   
  
  
$.extend($.fn.validatebox.defaults.rules, {     
    idcared: {     
        validator: function(value,param){    
            var flag= isCardID(value);  
            return flag==true?true:false;    
        },     
        message: '不是有效的身份证号码'    
    }     
});  

//设置好需要提交的表单

$("#uploader").powerWebUpload({ auto: true,fileNumLimit:10,serverPath:'${ctx}/servlet/file/upload',fileType:'doc,xls,docx,xlsx,pdf'});
$('#moveInAddInfo').form({
	url:'${ctx}/culprit/moveIn/save',
	onSubmit:function(){
		 progressLoad();
		 var isValid = $(this).form('validate');
         if (!isValid) {
             progressClose();
         }
         return isValid;
	},
	success:function(data){
		progressClose();
		data = JSON.parse(data);
		if(data.status==200){
			$.messager.show({
				title:'提示信息!' ,
				msg:data.msg
			});
			
			 parent.$.modalDialog.openner_dataGrid.datagrid('reload');//之所以能在这里调用到parent.$.modalDialog.openner_dataGrid这个对象，是因为user.jsp页面预定义好了
             parent.$.modalDialog.handler.dialog('close');
			
		}else{
			 parent.$.messager.alert('错误', result.msg, 'error');
		}
		
	}
});	
/*选择户口省触发省下面的市*/
$('#regResidenceProId').combobox({
	onSelect: function(record){
		$('#regResidenceCityId').combobox({    
			url:'${ctx}/culpritinfo/culprit/findAreaByLevel?areaParent='+record.id,    
		    valueField:'id',    
		    textField:'areaName',
		    editable:'false'   
		}); 
	}
});
var regflag = false;
/*选择户口市触发市下面的县*/
$('#regResidenceCityId').combobox({
	onChange: function(newValue,oldValue){
		regflag =true;
			$('#regResidenceCountryId').combobox({    
			url:'${ctx}/culpritinfo/culprit/findAreaByLevel?areaParent='+newValue,    
		    valueField:'id',    
		    textField:'areaName',
	    editable:'false' 
			}); 
	},
	onSelect: function(record){
		if (regflag != true) {
			regflag =true;
   			$('#regResidenceCountryId').combobox({    
   			url:'${ctx}/culpritinfo/culprit/findAreaByLevel?areaParent='+record.id,    
   		    valueField:'id',    
   		    textField:'areaName',
		    editable:'false' 
   			}); 
		}
	}
});
/*选择固定居住省触发省下面的市*/
	$('#addressProId').combobox({    
		onSelect: function(record){
		$('#addressCityId').combobox({    
			url:'${ctx}/culpritinfo/culprit/findAreaByLevel?areaParent='+record.id,    
		    valueField:'id',    
		    textField:'areaName',
		    editable:'false'    
		}); 
	}   
	}); 
 /*选择固定居住省触发省下面的市*/
	 /* $('#addressCityId').combobox({    
		url:'${ctx}/culpritinfo/culprit/findAreaByLevel?areaParent=46',    
	    valueField:'id',    
	    textField:'areaName',
    editable:'false'    
	});    */

	var addflag = false;
/*选择固定市触发市下面的县*/
$('#addressCityId').combobox({
		onChange: function(newValue,oldValue){
		addflag = true;
			$('#addressCountryId').combobox({    
			url:'${ctx}/culpritinfo/culprit/findAreaByLevel?areaParent='+newValue,    
		    valueField:'id',    
		    textField:'areaName',
	    editable:'false' 
			}); 
	},
	onSelect: function(record){
		if(addflag != true)
		{
			addflag = true;
   			$('#addressCountryId').combobox({    
   			url:'${ctx}/culpritinfo/culprit/findAreaByLevel?areaParent='+record.id,    
   		    valueField:'id',    
   		    textField:'areaName',
		    editable:'false' 
   			}); 
		}
	}

});

</script>